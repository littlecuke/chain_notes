####重入攻击

[实例+解析+预防](https://blog.csdn.net/henrynote/article/details/82119116)

##### 预防

* 使用内置transfer()函数，transfer() 函数仅发送 2300 Gas 给外部调用，这不足以使目的地址合约调用另一个合约（即重入原合约）
* 是确保所有改变状态变量的逻辑，都发生在以太币被发送出合约（或任何外部调用）之前 （先预先做好扣减或者状态变更在做发送调用）
* 引入互斥锁。也就是说，添加一个状态变量，在代码执行期间锁定合约，防止重入调用。

#####简介

以太坊智能合约能够调用和利用其他外部合约的代码。合约通常也处理以太币，因此将以太币发送到各种外部用户地址。调用外部合约或将以太币发送到地址的操作要求合约提交外部调用。这些外部调用可以被攻击者劫持，从而迫使合约执行更多的代码（即通过 fallback 回退函数），包括回调原合约本身。所以，合约代码执行过程中将可以“重入”该合约，有点像编程语言里面的间接递归函数调用。在臭名昭著的The DAO事件中黑客使用了这种攻击，最终导致了以太坊的硬分叉。


#####漏洞细节

当合约将以太币发送到未知地址时，可能会发生此攻击。攻击者可以在外部地址小心地构建合约，该地址包含回退函数中的恶意代码。因此，当合约把以太币发送到此地址时，将激活恶意代码。通常，恶意代码在易受攻击的合约上执行函数，是开发人员没有预期的操作。

“Re-entrancy”的名称来自这样的现实：外部恶意合约回调了受攻击合约上的一个函数，并在受攻击合约上的任意位置“重新进入”代码执行。因为原合约的程序员可能没有预料到合约代码可以被“重入”，因此合约会出现不可预知的行为。